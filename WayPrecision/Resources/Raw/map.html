<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset='utf-8' />
    <title>GPS Map</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='stylesheet' href='https://unpkg.com/leaflet/dist/leaflet.css' />

    <!--MarkerCluster-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <!--background-color: #333333;-->
    <div id='map' style="background-color: white; position: absolute; width: 100%; height: 100%; z-index: 1;"></div>

    <!--Jquery-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!--Turf-->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

    <!--leaflet-->
    <script src='https://unpkg.com/leaflet/dist/leaflet.js'></script>

    <!--MarkerCluster-->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>

    <!--L.easyButton`s-->
    <script src="https://cdn.jsdelivr.net/gh/jpatinocollado/uoc-tfg-wayprecision@refs/heads/features/013-jsdelivr/WayPrecision/Resources/Raw/Javascript/easy-button.js"></script>

    <!--Loading-->
    <script src="https://cdn.jsdelivr.net/gh/jpatinocollado/uoc-tfg-wayprecision@refs/heads/features/013-jsdelivr/WayPrecision/Resources/Raw/Javascript/jquery.loading.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jpatinocollado/uoc-tfg-wayprecision@refs/heads/features/013-jsdelivr/WayPrecision/Resources/Raw/Javascript/LoadingManagerService.js"></script>

    <!--Backend comunication-->
    <script>
        var postMessageToBackend = function (message) {
            if (window.chrome && window.chrome.webview) {
                // Windows
                window.chrome.webview.postMessage(message);
            } else if (window.external && window.external.notify) {
                // Android
                window.external.notify(message);
            } else if (typeof jsBridge !== "undefined") {
                // Android con AddJavascriptInterface
                // Android
                jsBridge.postMessage(message);
            } else {
                alert("No se encontró un canal de comunicación con .NET");
            }
        }
    </script>

    <!--Map GPS Manager-->
    <script>
        var MapGpsManagerService = (function () {
            //icono de posición GPS
            var gps = L.icon({
                iconUrl: 'data:image/png;base64,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',
                iconSize: [15, 20],
                iconAnchor: [7, 20],
                popupAnchor: [0, -20],
            });

            var gpsNoDirection = L.icon({
                iconUrl: 'data:image/png;base64,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',
                iconSize: [15, 20],
                iconAnchor: [7, 20],
                popupAnchor: [0, -20],
            });

            var actualPosition = L.layerGroup();

            var getLayer = function () {
                return actualPosition;
            }

            var setGpsPosition = function (lat, lng, center, angle) {
                var latLang = L.latLng(lat, lng);

                let icon = gpsNoDirection;
                if (angle)
                    icon = gps;

                var markerPosition = L.marker(latLang, { icon: icon, rotationAngle: angle })
                    .bindPopup('<b>Hola,</b><br>Este eres tú.');
                actualPosition.clearLayers();
                actualPosition.addLayer(markerPosition);
                if (center)
                    MapManagerService.SetView(lat, lng);
            }
            var clearGpsPosition = function () {
                actualPosition.clearLayers();
            }

            var removeLayer = function () {
                actualPosition.remove();
            }
            //return plublic methods of service
            return {
                GetLayer: getLayer,
                RemoveLayer: removeLayer,
                SetGpsPosition: setGpsPosition,
                ClearGpsPosition: clearGpsPosition
            };
        })();
    </script>

    <!--Map Events-->
    <script>
        var MapEventsManagerService = (function () {
            var register = function () {
                var map = MapManagerService.GetMap();

                //set events
                map.on('dblclick', onMapDblClick);
                map.on('zoomstart', onMapZoomStart);
                map.on('zoomend', onMapZoomEnd);
                map.on('move', onMapMove);

            }

            var onMapZoomStart = function (e) {
                var map = MapManagerService.GetMap();
                console.log('[onMapZoomStart]:', e);
                postMessageToBackend('setLastZoom;' + map.getZoom());
            }

            var onMapZoomEnd = function (e) {
                let map = MapManagerService.GetMap();
                console.log('[onMapZoomEnd] Layer:', e);

                postMessageToBackend('setZoom;' + map.getZoom());
            }

            var onMapMove = function (e) {
                var map = MapManagerService.GetMap();
                var latlng = map.getCenter();
                console.log('[onMapMove]:', latlng);
                postMessageToBackend('setLastCenter;' + latlng.lat + ';' + latlng.lng);
            }

            var onMapDblClick = function (e) {
                postMessageToBackend('createWaypoint;' + e.latlng.lat + ';' + e.latlng.lng);
            }

            //return plublic methods of service
            return {
                Register: register,
            };
        })();
    </script>

    <!--Map Waypoints-->
    <script>
        var WaypointManagerService = (function () {
            var waypoints = L.markerClusterGroup({
                spiderfyOnMaxZoom: false,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });
            var waypointsList = {};

            var getLayer = function () {
                return waypoints;
            }

            var clearWaypoints = function () {
                console.log("Clear Layer Waypoints");
                waypoints.clearLayers();
                waypointsList = {};
            }

            var addWaypoint = function (waypoint) {
                console.log("Add Waypoint in Layer", waypoint);

                var latLang = L.latLng(waypoint.lat, waypoint.lng);
                waypointsList[waypoint.id] = L.marker(latLang).on('click', function () {
                    waypointOnClick(waypoint);
                }).bindTooltip(waypoint.name);

                if (waypoint.visible)
                    waypointsList[waypoint.id].addTo(waypoints);

                console.log("layer waypoints", waypoints);
            }

            var waypointOnClick = function (waypoint) {
                postMessageToBackend('editWaypoint;' + waypoint.id);
            }

            var fitWaypoint = function (id) {
                postMessageToBackend("disableCenterLocation");
                MapManagerService.FitEstate();

                console.log("Fit Waypoint", id);
                var latlng = waypointsList[id].getLatLng();
                var map = MapManagerService.GetMap();
                map.setView(latlng, map.getMaxZoom());
            }

            var removeLayer = function () {
                waypoints.remove();
            }

            //return plublic methods of service
            return {
                //Waypoints
                GetLayer: getLayer,
                RemoveLayer: removeLayer,
                ClearWaypoints: clearWaypoints,
                AddWaypoint: addWaypoint,
                FitWaypoint: fitWaypoint,
                //Waypoints
            };
        })();
    </script>

    <!--Map Tracks-->
    <script>
        var TrackManagerService = (function () {
            //Layer group for all tracks
            var tracks = L.layerGroup();
            var trackList = {};

            var getLayer = function () {
                return tracks;
            }

            const setStyleTrack = (weight, color, fillColor, opacity, fillopacity) => {
                return {
                    "opacity": opacity,     //1
                    "weight": weight,
                    "fillColor": fillColor,
                    "color": color,
                    "fillOpacity": fillopacity  //0.5
                }
            }

            var addTrack = function (track) {
                console.log('Add Track', track);

                var type;
                var lineLength;
                var polygonArea;
                var polygonLength;
                var alt = '<bold>' + track.name + '</bold>';
                if (track.type == "LineString") {
                    type = track.lineString;
                    lineLength = turf.length(track.lineString, { units: 'meters' });

                    if (track.length)
                        alt += '<br /> Longitud: ' + track.length;
                } else {
                    type = track.polygon;
                    polygonArea = turf.area(track.polygon);
                    polygonLength = turf.length(track.polygon, { units: 'meters' });

                    if (track.area)
                        alt += '<br /> Área: ' + track.area;
                    if (track.length)
                        alt += '<br /> Perímetro: ' + track.length;
                }

                trackList[track.id] = L.geoJSON(type, {
                    style: setStyleTrack(track.weight, track.color, track.fillColor, track.opacity, track.fillopacity),
                    onEachFeature: function onEachFeature(feature, layer) {
                        layer.on('dblclick', function (e) {
                            postMessageToBackend('editTrack;' + track.id);
                        });
                    }
                }).bindTooltip(alt);

                if (track.visible)
                    trackList[track.id].addTo(tracks);

                postMessageToBackend('updateTrack;' + track.id + ';' + lineLength + ';' + polygonArea + ';' + polygonLength);
            }

            var clearTracks = function () {
                tracks.clearLayers();
                trackList = {};
            }

            var fitTrack = function (id) {
                postMessageToBackend("disableCenterLocation");
                MapManagerService.FitEstate();

                console.log('Fit Track', id);

                let bounds = trackList[id].getBounds();
                var map = MapManagerService.GetMap();
                map.setZoom(map.getMaxZoom());
                map.fitBounds(bounds);

                console.log('bounds', bounds);
            }

            var removeLayer = function () {
                tracks.remove();
            }

            //return plublic methods of service
            return {
                GetLayer: getLayer,
                RemoveLayer: removeLayer,
                ClearTracks: clearTracks,
                AddTrack: addTrack,
                FitTrack: fitTrack
            };
        })();
    </script>

    <!--Map Layers-->
    <script>
        var MapLayersManagerService = (function () {
            var baseMapsArr;
            var baseMaps;
            var overlayMaps;
            var layerControls = L.control.layers(baseMaps, overlayMaps, { collapsed: false });
            var IsModeEdicio = false;
            var currentLayer;
            var layerControlsAdicionals;
            var layerControlsWms;
            var layerControlsWmsProject;

            var chkWaypoints = true;
            var chkTracks = true;

            var baseLayerName = "OpenStreetMap";
            var baseLayerOpacity = 1;

            var addLayers = function (idLayer) {
                baseMaps = new Object();
                baseMapsArr = [];

                console.log("creando capa openstreetmaps");
                addOpenStreetMaps();

                console.log("creando controles de vista");
                createControlsView();
            }

            var addOpenStreetMaps = function () {
                var openStreetMaps = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                });

                baseMaps["OpenStreetMap"] = openStreetMaps;
                baseMapsArr.push(openStreetMaps);
            }

            var createControlsView = function () {
                var map = MapManagerService.GetMap();

                //Layer tracks
                var layerTracks = TrackManagerService.GetLayer();
                layerTracks.options.className = "OVLY#Tracks";

                //Layer waypoints
                var layerWaypoints = WaypointManagerService.GetLayer();
                layerWaypoints.options.className = "OVLY#Waypoints";

                //Layer actual position
                var layerActualPosition = MapGpsManagerService.GetLayer();

                overlayMaps = { 'Waypoints': layerWaypoints, 'Tracks': layerTracks, };

                layerControls.remove();
                layerControls = L.control.layers(baseMaps, overlayMaps, { collapsed: true });
                layerControls.addTo(map);

                if (chkTracks)
                    layerTracks.addTo(map);
                else
                    layerTracks.removeFrom(map);

                if (chkWaypoints)
                    layerWaypoints.addTo(map);
                else
                    layerWaypoints.removeFrom(map);

                layerActualPosition.addTo(map);

                var map = MapManagerService.GetMap();

                if (baseMaps[baseLayerName]) {
                    currentLayer = baseMaps[baseLayerName];
                    map.addLayer(currentLayer);
                }
            }

            //return plublic methods of service
            return {
                AddLayers: addLayers,
                CreateControlsView: createControlsView,

            };
        })();
    </script>

    <!--Map Manager-->
    <script>
        var MapManagerService = (function () {
            var LeafletMap;
            var IsDevelop;
            var IdProyecto;
            let buttonNavigation;
            let IsEnableLocation = false;
            let IsEnableCenterLocation = false;

            var getIsDevelop = function () {
                return IsDevelop;
            }

            var getMap = function () {
                return LeafletMap;
            }

            var getIdProyecto = function () {
                return IdProyecto;
            }

            var iniciarPantalla = function (idLastLayer, isDevelop, idProyecto) {
                IsDevelop = isDevelop;
                IdProyecto = idProyecto;
                //instance the map
                LeafletMap = L.map('map',
                    {
                        zoomControl: true,
                        doubleClickZoom: false,
                        boxZoom: false,
                        maxZoom: 19,
                    });

                //set events
                MapEventsManagerService.Register();

                //center map
                LeafletMap.fitWorld();

                //add layers
                console.log("añadiendo capas");
                MapLayersManagerService.AddLayers(idLastLayer);

                //Custom Buttons to edit
                console.log("añadiendo botones laterales");

                //boton de navegación
                buttonNavigation = L.easyButton({
                    states: [{
                        stateName: 'location-disable',
                        icon: '<img width="24" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAGHaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj48dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4slJgLAAAA+0lEQVRYR72UwRKEMAhD6/7/P7sXcbJIgLR134wXhCRw6BhrnNc3zccX/s3hCwnqpi3tTpNq7Ek90p8bzA3qQ39sNDdCr7AomNu82s8LDbFoBpHmvVg27HsrWlrdd0A1H90ZDMASt4QA1GGzd0/3AhX2JJswW+ZBFYBtYKApgnOpRhUgwm+7hBJgmylyJKLqI2Owk4c6ygVeAdNGCdk2Q+ynvSsXYGYSKwG2UAWITsdgF0k1qgCvgwGmNrhQZ+/+7gWYUEZrJkpeDUYziDTPxCoRQ30tH36PAtAV7RJ6hUVgVwjqQ38AqyFSj/SnQw2iaE9zTgT7ofsOvMYXVUIwIVOMQ/UAAAAASUVORK5CYII=" />',
                        title: 'Habilitar localización',
                        onClick: function (btn, map) {
                            LoadingManagerService.Show('Activando localización...');

                            postMessageToBackend("enableLocation");
                            postMessageToBackend("enableCenterLocation");

                            LoadingManagerService.Hide();
                            btn.state('location-enable');

                            IsEnableLocation = true;
                            IsEnableCenterLocation = true;
                        }
                    }, {
                        stateName: 'location-enable', // name the state
                        icon: '<img width="24" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAGHaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj48dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4slJgLAAABCklEQVRYR72WwRWEMAhEcQvYErc4S7QB94RiZGBIov+IMDNwyFNkhHXbZd32tlzh0xbeZmkLkOqmvy+lnTdVjVuSIOHHYXMlCAE/TDNXQAi3SJuraLXfcCukYo7IheL8VSwazoxbSC3uHaiaCz9zBkCJSaEDq4NmTQ93gQx9klUYLeMQB0AbKNbUYucSjTiAR7vtIHyAiaaWBYpWHxkFnRzo8Bd4iDOtlxBtI8X+oLf/AsisSH+AScQBvNMh0EUSjTjAC5wBOjcQ6Zg1/dwFkFAEOXNPng2ibZXivC+WiSjV19IJfyscsKIsjrmEAWRiCGAuaQCZECIwFyqAUg2SGM9hHf9H4N6BB/kDiZmKpZ8LOc0AAAAASUVORK5CYII=" />',
                        title: 'Seguimiento sin centrar', // like its title
                        onClick: function (btn, map) {       // and its callback
                            LoadingManagerService.Show('Desactivando centrar en el mapa...');

                            postMessageToBackend("disableCenterLocation");

                            LoadingManagerService.Hide();
                            btn.state('location-enable-move');

                            IsEnableLocation = true;
                            IsEnableCenterLocation = true;

                        }
                    }, {
                        stateName: 'location-enable-move', // name the state
                        icon: '<img width="24" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAGHaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj48dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4slJgLAAABDklEQVRYR72WPRaDQAiEMVdIa+n9T5QyrWcwFfsIMvys6NdlhZmBgheiC+zrduzrduj3Ci/98DSLfkBUJ31/PyntsKhqrImCuB+vmjNeCPihy5xBIczHrDmLVuslp4dIzBKRVPv/fnjNujEiq5W6A1VzKvSMAChxVoiROqhX1qQ2EMEnmYXRMBZuADQBI00lsi/ScANY6Gmvkg7QaSpZkGj1yDBo5UgnvYG7GGmthGgaKtZ7tdMbQGZVpgN04QawVodAG4k03ABPMALMTkATvbI+tQEk5JHtOSWPGtG0TLXfFItEmOq11OaEAlBBNItlTl4AagyBzCkKQA0hPHPKBGCqQSLjFvaG/wipO3AnPzElqGojdMIzAAAAAElFTkSuQmCC" />',
                        title: 'deshabilitar localización', // like its title
                        onClick: function (btn, map) {       // and its callback
                            LoadingManagerService.Show('Desactivando localización...');

                            postMessageToBackend("disableLocation");

                            LoadingManagerService.Hide();
                            MapGpsManagerService.ClearGpsPosition();
                            btn.state('location-disable');

                            IsEnableLocation = true;
                            IsEnableCenterLocation = false;
                        }
                    }
                    ]
                });
                buttonNavigation.addTo(MapManagerService.GetMap());

                //add scale
                L.control.scale({
                    imperial: false
                }
                ).addTo(LeafletMap);

                postMessageToBackend('mapLoaded');
                console.log("ocultando loader");
                LoadingManagerService.Hide();
            }

            var setView = function (lat, lng) {
                var latLng = L.latLng(lat, lng);
                LeafletMap.setView(latLng, LeafletMap.getZoom());
            }

            var setBounds = function (center1, center2, center3, center4) {
                LeafletMap.fitBounds([
                    [center1, center2],
                    [center3, center4]
                ]);
            }

            var disableZoom = function () {
                LeafletMap.touchZoom.disable();
                LeafletMap.doubleClickZoom.disable();
                LeafletMap.scrollWheelZoom.disable();
                LeafletMap.boxZoom.disable();
                LeafletMap.keyboard.disable();
            }
            var enableZoom = function () {
                LeafletMap.touchZoom.enable();
                LeafletMap.doubleClickZoom.enable();
                LeafletMap.scrollWheelZoom.enable();
                LeafletMap.boxZoom.enable();
                LeafletMap.keyboard.enable();
            }

            var setZoom = function (zoom) {
                LeafletMap.setZoom(zoom);
            }

            var setZoomMax = function () {
                LeafletMap.setZoom(LeafletMap.getMaxZoom());
            }

            var enableDisableMapMove = function (enable) {
                if (enable)
                    LeafletMap.dragging.enable();
                else
                    LeafletMap.dragging.disable();
            }

            var fitEstate = function () {
                console.log('fitEstate');
                console.log('IsEnableLocation:', IsEnableLocation);
                console.log('IsEnableCenterLocation:', IsEnableCenterLocation);
                if (IsEnableLocation && IsEnableCenterLocation) {
                    console.log('fitEstate');
                    buttonNavigation.state('location-enable-move');
                    IsEnableCenterLocation = false;
                }
            }

            //return plublic methods of service
            return {
                GetIdProyecto: getIdProyecto,
                GetIsDevelop: getIsDevelop,
                IniciarPantalla: iniciarPantalla,
                GetMap: getMap,

                //Map controls
                SetView: setView,
                SetZoom: setZoom,
                SetBounds: setBounds,
                SetZoomMax: setZoomMax,
                EnableDisableMapMove: enableDisableMapMove,
                //Map controls

                EnableZoom: enableZoom,
                DisableZoom: disableZoom,

                //fit
                FitEstate: fitEstate
            };
        })();
    </script>

    <!--Screen init-->
    <script>
        $(document).ready(function () {
            LoadingManagerService.Show("Cargando mapa...");
            MapManagerService.IniciarPantalla(1, true, 1);

            replaceAttributionLink();
        });

        function replaceAttributionLink() {
            var attribution = document.querySelector('.leaflet-control-attribution.leaflet-control');
            if (!attribution) return;

            var link = attribution.querySelector('a');
            if (link) {
                // Creamos un span para reemplazar el enlace
                var span = document.createElement('span');
                span.title = link.title;
                span.innerHTML = link.innerHTML; // Conserva el SVG y el texto

                // Reemplazamos el enlace por el span
                attribution.replaceChild(span, link);
            }
        }

        //funcion de actualizar la posición en mapa
        function updatePosition(lat, lng, center, angle) {
            console.log('lat: ' + lat);
            console.log('lng: ' + lng);

            if (MapManagerService.GetMap().getZoom() <= 1)
                MapManagerService.SetZoomMax();

            MapGpsManagerService.SetGpsPosition(lat, lng, center, angle);

        }
    </script>
</body>
</html>